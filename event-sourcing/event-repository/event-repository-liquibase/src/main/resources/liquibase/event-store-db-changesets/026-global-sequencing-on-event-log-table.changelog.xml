<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet
            id="event-store-026"
            author="TechPod"
            logicalFilePath="026-global-sequencing-on-event-log-table.changelog.xml">

        <addColumn tableName="event_log">
            <column name="previous_event_number" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="event_log">
            <column name="is_published" type="BOOLEAN" defaultValue="TRUE"/>
        </addColumn>
        <addColumn tableName="event_log">
            <column name="event_status" type="VARCHAR(64)" defaultValue="HEALTHY"/>
        </addColumn>
        <sql>
            create index event_log_date_created_without_event_number_idx on event_log (date_created) where event_number is null;
        </sql>
        <dropNotNullConstraint tableName="event_log" columnName="event_number" />

        <sql>
            create index publish_queue_date_queued_idx on publish_queue (date_queued);
        </sql>

        <rollback>
            <dropIndex
                    indexName="publish_queue_date_queued_idx"
                    tableName="publish_queue"/>
            <dropIndex
                    indexName="event_log_date_created_without_event_number_idx"
                    tableName="event_log"/>
            <addNotNullConstraint
                    tableName="event_log"
                    columnName="event_number"/>
            <dropColumn tableName="event_log">
                <column name="is_published"/>
            </dropColumn>
            <dropColumn tableName="event_log">
                <column name="previous_event_number"/>
            </dropColumn>
            <dropColumn tableName="event_log">
                <column name="event_status"/>
            </dropColumn>
        </rollback>

    </changeSet>
</databaseChangeLog>
