<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet
            id="event-store-026"
            author="TechPod"
            logicalFilePath="026-global-sequencing-on-event-log-table.changelog.xml">

        <addColumn tableName="event_log">
            <column name="previous_event_number" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="event_log">
            <column name="is_published" type="BOOLEAN" defaultValue="FALSE"/>
        </addColumn>
        <dropNotNullConstraint tableName="event_log" columnName="event_number" />
        <dropDefaultValue tableName="event_log" columnName="event_number" />
        <dropSequence sequenceName="event_sequence_seq"/>
        <sql>
            create index event_log_date_created_without_event_number_idx on event_log (date_created) where event_number is null;
        </sql>

        <sql>
            create index publish_queue_date_queued_idx on publish_queue (date_queued);
        </sql>

        <dropTable tableName="pre_publish_queue" />

        <rollback>
            <createTable tableName="pre_publish_queue">
                <column name="event_log_id" type="UUID">
                    <constraints primaryKey="true" nullable="false"/>
                </column>
                <column name="date_queued" type="TIMESTAMP WITH TIME ZONE">
                    <constraints nullable="false"/>
                </column>
            </createTable>

            <dropIndex
                    indexName="publish_queue_date_queued_idx"
                    tableName="publish_queue"/>

            <dropIndex
                    indexName="event_log_date_created_without_event_number_idx"
                    tableName="event_log"/>
            <createSequence
                    sequenceName="event_sequence_seq"
                    cycle="false"/>
            <sql>
                SELECT setval(
                'event_sequence_seq',
                (SELECT MAX(event_number) FROM event_log)
                );
            </sql>
            <addDefaultValue
                    tableName="event_log"
                    columnName="event_number"
                    columnDataType="BIGINT"
                    defaultValueSequenceNext="event_sequence_seq"/>
            <addNotNullConstraint
                    tableName="event_log"
                    columnName="event_number"/>
            <dropColumn tableName="event_log">
                <column name="is_published"/>
            </dropColumn>
            <dropColumn tableName="event_log">
                <column name="previous_event_number"/>
            </dropColumn>
        </rollback>

    </changeSet>
</databaseChangeLog>
