<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet id="stream_buffer-015" author="TechPod"
               logicalFilePath="liquibase/event-buffer-changesets/015-create-stream-metrics-materialised-view.xml">

        <sql>
            CREATE
            MATERIALIZED VIEW IF NOT EXISTS stream_metrics AS
            SELECT (SELECT count(*) AS stream_count
                    FROM (SELECT DISTINCT stream_status.stream_id
                          FROM stream_status) temp)                        AS stream_count,
                   (SELECT count(*) AS streams_in_error_count
                    FROM (SELECT DISTINCT stream_error.stream_id
                          FROM stream_error) temp)                         AS streams_in_error_count,
                   (SELECT count(*) AS blocked_streams_count
                    FROM (SELECT DISTINCT stream_error.stream_id
                          FROM stream_error) temp)                         AS blocked_streams_count,
                   (SELECT count(*) AS up_to_date_streams_count
                    FROM (SELECT DISTINCT stream_status.stream_id
                          FROM stream_status
                          WHERE stream_status.is_up_to_date = true) temp)  AS up_to_date_streams_count,
                   (SELECT count(*) AS out_of_date_streams_count
                    FROM (SELECT DISTINCT stream_status.stream_id
                          FROM stream_status
                          WHERE stream_status.is_up_to_date = false) temp) AS out_of_date_streams_count;
        </sql>

        <rollback>
            <sql>
                DROP MATERIALIZED VIEW IF EXISTS stream_metrics;
            </sql>
        </rollback>

    </changeSet>

</databaseChangeLog>
