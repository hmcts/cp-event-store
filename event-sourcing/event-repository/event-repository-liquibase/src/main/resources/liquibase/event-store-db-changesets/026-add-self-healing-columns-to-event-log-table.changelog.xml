<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet
            id="event-store-026"
            author="TechPod"
            logicalFilePath="026-add-self-healing-columns-to-event-log-table.changelog.xml">

        <addColumn tableName="event_log">
            <column name="previous_event_number" type="BIGINT"/>
        </addColumn>
        <addColumn tableName="event_log">
            <column name="is_published" type="BOOLEAN" defaultValue="FALSE"/>
        </addColumn>
        <sql>
            CREATE INDEX IF NOT EXISTS idx_event_log_not_sequenced ON event_log(date_created) WHERE previous_event_number IS NULL;
            CREATE INDEX IF NOT EXISTS idx_event_log_not_published ON event_log(date_created) WHERE is_published = FALSE;
            CREATE INDEX IF NOT EXISTS idx_event_log_global_sequence ON event_log(previous_event_number,event_number);
        </sql>

        <rollback>
            <sql>DROP INDEX IF EXISTS idx_event_log_global_sequence;</sql>
            <sql>DROP INDEX IF EXISTS idx_event_log_not_published;</sql>
            <sql>DROP INDEX IF EXISTS idx_event_log_not_sequenced;</sql>
            <dropColumn tableName="event_log">
                <column name="sequencing_status"/>
            </dropColumn>
            <dropColumn tableName="event_log">
                <column name="is_published"/>
            </dropColumn>
            <dropColumn tableName="event_log">
                <column name="previous_event_number"/>
            </dropColumn>
        </rollback>
        
    </changeSet>
</databaseChangeLog>
